;
WRITE_COFF_DEBUG_HEADER:

	;;PUSH	ES

	MOV	AL,[FLG.D]
	OR	AL,AL
	JE	WRITE_COFF_DEBUG_HEADER.R


	;;PUSH	DS
	;;POP	ES

	MOV	AX,4200h
	MOV	EBX,[HDL2]
	XOR	ECX,ECX
	MOV	EDX,00CCh	;PointerToSymbolTable
	;MOV	DX,00D0h	;NumberOfSymbol
	;INT	21h
	CALL	INT21_seek

	MOV	EAX,[COFF_SYMBOLS_HEADER_OFF]
	ADD	EAX,20h
;		mov	eax,0
	MOV	[COFF_BUF],EAX
	XOR	EAX,EAX
	MOV	AX,[LBL.NO]
;		mov ax,0
	MOV	[COFF_BUF+4],AX

	MOV	AX,4000h
	MOV	EBX,[HDL2]
	MOV	ECX,4+4
	MOV	EDX,COFF_BUF
	;INT	21h
	CALL	INT21_write

	MOV	EBX,[PNT2]
	PUSH	EBX
	MOV	ESI,STR_IMAGE_DEBUG_DIRECTORY	;ENTRY_DEBUG
	MOV	EDI,WORK2+1
	CALL	STRCPY

	MOV	AL,25		;len
	MOV	[WORK2],AL
	MOV	EBX,WORK2
	MOV	[PNT2],EBX
	CALL	SRCHL
	POP	EBX
	MOV	[PNT2],EBX
	JNB	WRITE_COFF_DEBUG_HEADER.10

	MOV	EDX,EMES_NO_DEBUG_ENTRY
	CALL	DOS09

	JMP	WRITE_COFF_DEBUG_HEADER.R

WRITE_COFF_DEBUG_HEADER.10:
	MOV	EAX,[VAL1]
	PUSHAD
	PUSH	EAX
	SHR	EAX,10H
	MOV	BX,AX
	CALL	PUTH2

	POP	EAX
	MOV	BX,AX
	CALL	PUTH2
	POPAD

	SUB	EAX,IMAGE_BASE	;00400000h
	MOV	[IMAGE_DEBUG_DIRECTORY_OFF],EAX

	MOV	ECX,EAX
	MOV	DX,AX
	SHR	ECX,10h

	MOV	AX,4200H
	MOV	EBX,[HDL2]
	;INT	21h
	CALL	INT21_seek

	;MOV	EAX,0		;size
	MOV	EAX,[PUT_DEBUG_LONGSTR_TOTAL_SIZE]
	ADD	EAX,4
	MOV	ECX,EAX

	XOR	EAX,EAX
	XOR	EDX,EDX
	MOV	AX,[LBL.NO]
	MOV	DX,AX
	SHL	EAX,4
	ADD	EAX,EDX
	ADD	EAX,EDX		;*12h

	ADD	EAX,ECX

	ADD	EAX,20h		;for symbols_header

	MOV	EDI,IMAGE_DEBUG_DIRECTORY
	MOV	[EDI+10h],EAX	;SizeOfData

	MOV	EAX,[COFF_SYMBOLS_HEADER_OFF]
	MOV	[EDI+18h],EAX	;PointerToRawData

	MOV	AX,4000H	;write
	MOV	EBX,[HDL2]
	MOV	EDX,IMAGE_DEBUG_DIRECTORY	;EDX,USRDMA
	MOV	ECX,1ch	;20h
	;INT	21h
	CALL	INT21_write


;#6 IMAGE_DIRECTORY_ENTRY_DEBUG

	MOV	AX,4200h	;seek
	MOV	EBX,[HDL2]
	XOR	ECX,ECX
	MOV	EDX,0168h
	;INT	21h
	CALL	INT21_seek

	MOV	EAX,[IMAGE_DEBUG_DIRECTORY_OFF]
	MOV	[COFF_BUF],EAX
	MOV	EAX,1ch*1
	MOV	[COFF_BUF+4],EAX

	MOV	AX,4000h	;write
	MOV	EBX,[HDL2]
	MOV	ECX,4+4
	MOV	EDX,COFF_BUF
	;INT	21h
	CALL	INT21_write

WRITE_COFF_DEBUG_HEADER.R:
	;;POP	ES
	RET
